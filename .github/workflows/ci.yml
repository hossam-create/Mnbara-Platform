name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  auth-service:
    name: Lint and Test (auth-service)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies (auth-service)
        working-directory: services/auth-service
        run: npm ci

      - name: Run lint (auth-service)
        working-directory: services/auth-service
        run: npm run lint

      - name: Run tests (auth-service)
        working-directory: services/auth-service
        run: npm test -- --runInBand

  web-build:
    name: Web App Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install web dependencies
        run: |
          if [ -d "web/mnbara-web" ]; then
            cd web/mnbara-web
            npm ci || npm install
          fi

      - name: Build web app
        run: |
          if [ -d "web/mnbara-web" ]; then
            cd web/mnbara-web
            npm run build || echo "Build script not configured yet"
          fi

  docker-compose-check:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker-compose config

      - name: Check for secrets
        run: |
          echo "Checking for potential secrets in codebase..."

          # Check for .env files
          if git ls-files | grep -E '\\.env$'; then
            echo "❌ ERROR: .env files found in repository"
            exit 1
          fi

          # Check for common secret patterns
          if git grep -E '(aws_secret_key|stripe_secret|jwt_secret|password\\s*=\\s*[\"\\047][^\"\\047]+[\"\\047])' -- ':!*.md' ':!*.yml' ':!*.yaml'; then
            echo "⚠️ WARNING: Potential secrets found in code"
            echo "Please review the matches above"
          fi

          echo "✅ No .env files found in repository"

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run npm audit
        run: |
          services=("auth-service" "listing-service" "auction-service" "payment-service")
          for service in "${services[@]}"; do
            if [ -f "services/$service/package.json" ]; then
              echo "Auditing $service..."
              cd "services/$service"
              npm audit --audit-level=high || echo "Vulnerabilities found in $service"
              cd ../..
            fi
          done

  gitleaks:
    name: Gitleaks Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for Gitleaks to scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: only for Gitleaks Pro
