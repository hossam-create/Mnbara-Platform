# External Secrets Operator Configuration
# This file configures ExternalSecret resources to sync secrets from external providers
# Supported providers: AWS Secrets Manager, HashiCorp Vault, Azure Key Vault, GCP Secret Manager

{{- if .Values.externalSecrets.enabled }}
---
# ClusterSecretStore for AWS Secrets Manager
{{- if eq .Values.externalSecrets.provider "aws" }}
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "mnbara.fullname" . }}-aws-secrets
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  provider:
    aws:
      service: SecretsManager
      region: {{ .Values.externalSecrets.aws.region | default "us-east-1" }}
      {{- if .Values.externalSecrets.aws.role }}
      role: {{ .Values.externalSecrets.aws.role }}
      {{- end }}
      auth:
        {{- if .Values.externalSecrets.aws.serviceAccountRef }}
        jwt:
          serviceAccountRef:
            name: {{ .Values.externalSecrets.aws.serviceAccountRef }}
        {{- end }}
{{- end }}

---
# ClusterSecretStore for HashiCorp Vault
{{- if eq .Values.externalSecrets.provider "vault" }}
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: {{ include "mnbara.fullname" . }}-vault-secrets
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  provider:
    vault:
      server: {{ .Values.externalSecrets.vault.server }}
      path: {{ .Values.externalSecrets.vault.path | default "secret" }}
      version: {{ .Values.externalSecrets.vault.version | default "v2" }}
      auth:
        kubernetes:
          mountPath: {{ .Values.externalSecrets.vault.mountPath | default "kubernetes" }}
          role: {{ .Values.externalSecrets.vault.role }}
          serviceAccountRef:
            name: {{ include "mnbara.serviceAccountName" . }}
{{- end }}

---
# Database Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-database-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-database
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        postgres-password: "{{ `{{ .postgresPassword }}` }}"
        password: "{{ `{{ .userPassword }}` }}"
  data:
    - secretKey: postgresPassword
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.database | default "mnbara/database" }}
        property: postgres-password
    - secretKey: userPassword
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.database | default "mnbara/database" }}
        property: user-password

---
# Redis Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-redis-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-redis
    creationPolicy: Owner
  data:
    - secretKey: redis-password
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.redis | default "mnbara/redis" }}
        property: password

---
# RabbitMQ Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-rabbitmq-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-rabbitmq
    creationPolicy: Owner
  data:
    - secretKey: rabbitmq-password
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.rabbitmq | default "mnbara/rabbitmq" }}
        property: password

---
# JWT Secret External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-jwt-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-jwt
    creationPolicy: Owner
  data:
    - secretKey: jwt-secret
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.jwt | default "mnbara/jwt" }}
        property: secret

---
# Stripe Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-stripe-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-stripe
    creationPolicy: Owner
  data:
    - secretKey: secret-key
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.stripe | default "mnbara/stripe" }}
        property: secret-key
    - secretKey: webhook-secret
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.stripe | default "mnbara/stripe" }}
        property: webhook-secret

---
# PayPal Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-paypal-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-paypal
    creationPolicy: Owner
  data:
    - secretKey: client-id
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.paypal | default "mnbara/paypal" }}
        property: client-id
    - secretKey: secret
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.paypal | default "mnbara/paypal" }}
        property: secret

---
# OAuth Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-oauth-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-oauth
    creationPolicy: Owner
  data:
    - secretKey: google-client-id
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.oauth | default "mnbara/oauth" }}
        property: google-client-id
    - secretKey: google-client-secret
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.oauth | default "mnbara/oauth" }}
        property: google-client-secret
    - secretKey: apple-client-id
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.oauth | default "mnbara/oauth" }}
        property: apple-client-id
    - secretKey: apple-client-secret
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.oauth | default "mnbara/oauth" }}
        property: apple-client-secret

---
# MinIO Credentials External Secret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "mnbara.fullname" . }}-minio-external
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "mnbara.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ include "mnbara.fullname" . }}-{{ .Values.externalSecrets.provider }}-secrets
    kind: SecretStore
  target:
    name: {{ include "mnbara.fullname" . }}-minio
    creationPolicy: Owner
  data:
    - secretKey: root-user
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.minio | default "mnbara/minio" }}
        property: root-user
    - secretKey: root-password
      remoteRef:
        key: {{ .Values.externalSecrets.secretPaths.minio | default "mnbara/minio" }}
        property: root-password
{{- end }}
