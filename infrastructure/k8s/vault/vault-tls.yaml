# Vault TLS Configuration
# Configures TLS certificates for Vault using cert-manager
---
# Certificate Issuer for Vault (self-signed for internal use)
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: vault-selfsigned-issuer
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: tls
spec:
  selfSigned: {}

---
# CA Certificate for Vault
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-ca
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: tls
spec:
  isCA: true
  commonName: vault-ca
  secretName: vault-ca-secret
  duration: 87600h  # 10 years
  renewBefore: 8760h  # 1 year
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: vault-selfsigned-issuer
    kind: Issuer
    group: cert-manager.io

---
# CA Issuer using the generated CA
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: vault-ca-issuer
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: tls
spec:
  ca:
    secretName: vault-ca-secret

---
# Vault Server Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-server-tls
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: tls
spec:
  secretName: vault-tls
  duration: 8760h  # 1 year
  renewBefore: 720h  # 30 days
  subject:
    organizations:
      - MNBARA
  commonName: vault
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
    - client auth
    - digital signature
    - key encipherment
  dnsNames:
    - vault
    - vault.vault
    - vault.vault.svc
    - vault.vault.svc.cluster.local
    - vault-0.vault-internal
    - vault-1.vault-internal
    - vault-2.vault-internal
    - vault-0.vault-internal.vault.svc.cluster.local
    - vault-1.vault-internal.vault.svc.cluster.local
    - vault-2.vault-internal.vault.svc.cluster.local
    - vault-internal
    - vault-internal.vault
    - vault-internal.vault.svc
    - vault-internal.vault.svc.cluster.local
    - vault-active
    - vault-active.vault
    - vault-active.vault.svc
    - vault-active.vault.svc.cluster.local
    - vault-standby
    - vault-standby.vault
    - vault-standby.vault.svc
    - vault-standby.vault.svc.cluster.local
    - "*.vault-internal"
    - "*.vault-internal.vault.svc.cluster.local"
    - localhost
  ipAddresses:
    - 127.0.0.1
  issuerRef:
    name: vault-ca-issuer
    kind: Issuer
    group: cert-manager.io

---
# Ingress Certificate for external access (optional)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: vault-ingress-tls
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: tls
spec:
  secretName: vault-ingress-tls
  duration: 2160h  # 90 days
  renewBefore: 360h  # 15 days
  subject:
    organizations:
      - MNBARA
  commonName: vault.mnbara.com
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
    - digital signature
    - key encipherment
  dnsNames:
    - vault.mnbara.com
  issuerRef:
    # Use Let's Encrypt for production
    name: letsencrypt-prod
    kind: ClusterIssuer
    group: cert-manager.io

---
# Ingress for Vault UI (optional - for admin access)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vault-ui
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: ui
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/ssl-passthrough: "false"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # Restrict access to specific IPs (recommended)
    # nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8,192.168.0.0/16"
spec:
  tls:
    - hosts:
        - vault.mnbara.com
      secretName: vault-ingress-tls
  rules:
    - host: vault.mnbara.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: vault-active
                port:
                  number: 8200
