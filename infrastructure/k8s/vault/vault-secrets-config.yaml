# Vault Secrets Engine Configuration
# Configures KV secrets engine and migrates existing secrets
---
# ConfigMap for Vault initialization and secrets migration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-secrets-init
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: secrets
data:
  # Script to enable secrets engines and configure paths
  init-secrets-engines.sh: |
    #!/bin/sh
    set -e
    
    echo "Enabling KV secrets engine v2..."
    vault secrets enable -path=secret -version=2 kv || echo "KV engine already enabled"
    
    echo "Creating secrets paths for MNBARA services..."
    
    # Database credentials
    vault kv put secret/mnbara/database \
      postgres-password="${POSTGRES_PASSWORD}" \
      user-password="${DB_USER_PASSWORD}" \
      host="postgresql.mnbara.svc.cluster.local" \
      port="5432" \
      database="mnbara_db" \
      username="mnbara_user" \
      ssl-mode="require"
    
    # Redis credentials
    vault kv put secret/mnbara/redis \
      password="${REDIS_PASSWORD}" \
      host="redis-master.mnbara.svc.cluster.local" \
      port="6379"
    
    # RabbitMQ credentials
    vault kv put secret/mnbara/rabbitmq \
      password="${RABBITMQ_PASSWORD}" \
      username="mnbara_user" \
      host="rabbitmq.mnbara.svc.cluster.local" \
      port="5672"
    
    # JWT secrets
    vault kv put secret/mnbara/jwt \
      secret="${JWT_SECRET}" \
      refresh-secret="${JWT_REFRESH_SECRET}" \
      expiry="3600" \
      refresh-expiry="604800"
    
    # Stripe credentials
    vault kv put secret/mnbara/stripe \
      secret-key="${STRIPE_SECRET_KEY}" \
      webhook-secret="${STRIPE_WEBHOOK_SECRET}" \
      publishable-key="${STRIPE_PUBLISHABLE_KEY}"
    
    # PayPal credentials
    vault kv put secret/mnbara/paypal \
      client-id="${PAYPAL_CLIENT_ID}" \
      secret="${PAYPAL_SECRET}" \
      mode="sandbox"
    
    # OAuth credentials
    vault kv put secret/mnbara/oauth \
      google-client-id="${GOOGLE_CLIENT_ID}" \
      google-client-secret="${GOOGLE_CLIENT_SECRET}" \
      apple-client-id="${APPLE_CLIENT_ID}" \
      apple-client-secret="${APPLE_CLIENT_SECRET}"
    
    # MinIO credentials
    vault kv put secret/mnbara/minio \
      root-user="${MINIO_ROOT_USER}" \
      root-password="${MINIO_ROOT_PASSWORD}" \
      endpoint="minio.mnbara.svc.cluster.local:9000"
    
    # Elasticsearch credentials
    vault kv put secret/mnbara/elasticsearch \
      username="elastic" \
      password="${ELASTICSEARCH_PASSWORD}" \
      host="elasticsearch.mnbara.svc.cluster.local" \
      port="9200"
    
    # Encryption keys
    vault kv put secret/mnbara/encryption \
      database-key="${DATABASE_ENCRYPTION_KEY}" \
      field-encryption-key="${FIELD_ENCRYPTION_KEY}"
    
    # FCM/APNs credentials for notifications
    vault kv put secret/mnbara/notifications \
      fcm-server-key="${FCM_SERVER_KEY}" \
      apns-key-id="${APNS_KEY_ID}" \
      apns-team-id="${APNS_TEAM_ID}"
    
    # Blockchain/Web3 credentials
    vault kv put secret/mnbara/blockchain \
      infura-api-key="${INFURA_API_KEY}" \
      deployer-private-key="${DEPLOYER_PRIVATE_KEY}"
    
    echo "Secrets migration completed successfully!"

  # Script to configure secrets rotation
  configure-rotation.sh: |
    #!/bin/sh
    set -e
    
    echo "Configuring secrets rotation policies..."
    
    # Note: Vault Enterprise features like automatic rotation
    # require Vault Enterprise license. For OSS, use external
    # rotation mechanisms or scheduled jobs.
    
    echo "Rotation configuration completed!"

---
# Job to migrate existing secrets to Vault
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-secrets-migration
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: secrets-migration
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      serviceAccountName: vault-secrets-migration
      restartPolicy: OnFailure
      containers:
        - name: migrate-secrets
          image: hashicorp/vault:1.15
          command:
            - /bin/sh
            - -c
            - |
              # Wait for Vault to be ready and unsealed
              until vault status 2>/dev/null | grep -q "Sealed.*false"; do
                echo "Waiting for Vault to be unsealed..."
                sleep 5
              done
              
              # Login with Kubernetes auth
              vault login -method=kubernetes role=secrets-migration
              
              # Run migration script
              /scripts/init-secrets-engines.sh
          env:
            - name: VAULT_ADDR
              value: "https://vault.vault:8200"
            - name: VAULT_CACERT
              value: "/vault/tls/ca.crt"
            # Secrets from existing Kubernetes secrets
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mnbara-database
                  key: postgres-password
                  optional: true
            - name: DB_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mnbara-database
                  key: password
                  optional: true
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mnbara-redis
                  key: redis-password
                  optional: true
            - name: RABBITMQ_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mnbara-rabbitmq
                  key: rabbitmq-password
                  optional: true
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: mnbara-jwt
                  key: jwt-secret
                  optional: true
            - name: JWT_REFRESH_SECRET
              valueFrom:
                secretKeyRef:
                  name: mnbara-jwt
                  key: jwt-refresh-secret
                  optional: true
            - name: STRIPE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-stripe
                  key: secret-key
                  optional: true
            - name: STRIPE_WEBHOOK_SECRET
              valueFrom:
                secretKeyRef:
                  name: mnbara-stripe
                  key: webhook-secret
                  optional: true
            - name: STRIPE_PUBLISHABLE_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-stripe
                  key: publishable-key
                  optional: true
            - name: PAYPAL_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: mnbara-paypal
                  key: client-id
                  optional: true
            - name: PAYPAL_SECRET
              valueFrom:
                secretKeyRef:
                  name: mnbara-paypal
                  key: secret
                  optional: true
            - name: GOOGLE_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: mnbara-oauth
                  key: google-client-id
                  optional: true
            - name: GOOGLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: mnbara-oauth
                  key: google-client-secret
                  optional: true
            - name: APPLE_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: mnbara-oauth
                  key: apple-client-id
                  optional: true
            - name: APPLE_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: mnbara-oauth
                  key: apple-client-secret
                  optional: true
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: mnbara-minio
                  key: root-user
                  optional: true
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mnbara-minio
                  key: root-password
                  optional: true
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mnbara-elasticsearch
                  key: password
                  optional: true
            - name: DATABASE_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-encryption
                  key: database-key
                  optional: true
            - name: FIELD_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-encryption
                  key: field-encryption-key
                  optional: true
            - name: FCM_SERVER_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-notifications
                  key: fcm-server-key
                  optional: true
            - name: APNS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: mnbara-notifications
                  key: apns-key-id
                  optional: true
            - name: APNS_TEAM_ID
              valueFrom:
                secretKeyRef:
                  name: mnbara-notifications
                  key: apns-team-id
                  optional: true
            - name: INFURA_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-blockchain
                  key: infura-api-key
                  optional: true
            - name: DEPLOYER_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: mnbara-blockchain
                  key: deployer-private-key
                  optional: true
          volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: tls
              mountPath: /vault/tls
              readOnly: true
      volumes:
        - name: scripts
          configMap:
            name: vault-secrets-init
            defaultMode: 0755
        - name: tls
          secret:
            secretName: vault-tls

---
# ServiceAccount for secrets migration job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-secrets-migration
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: secrets-migration
