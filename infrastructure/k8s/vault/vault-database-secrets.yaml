# Vault Dynamic Database Credentials Configuration
# Configures dynamic credential generation for PostgreSQL
---
# ConfigMap for database secrets engine configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-database-config
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: database-secrets
data:
  # Script to configure database secrets engine
  configure-database-engine.sh: |
    #!/bin/sh
    set -e
    
    echo "Enabling database secrets engine..."
    vault secrets enable -path=database database || echo "Database engine already enabled"
    
    echo "Configuring PostgreSQL connection..."
    vault write database/config/mnbara-postgresql \
      plugin_name=postgresql-database-plugin \
      allowed_roles="mnbara-readonly,mnbara-readwrite,mnbara-admin" \
      connection_url="postgresql://{{username}}:{{password}}@postgresql.mnbara.svc.cluster.local:5432/mnbara_db?sslmode=require" \
      username="${POSTGRES_ADMIN_USER}" \
      password="${POSTGRES_ADMIN_PASSWORD}" \
      password_authentication="scram-sha-256"
    
    echo "Creating read-only role..."
    vault write database/roles/mnbara-readonly \
      db_name=mnbara-postgresql \
      creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; \
        GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"{{name}}\"; \
        GRANT USAGE ON SCHEMA public TO \"{{name}}\";" \
      revocation_statements="REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM \"{{name}}\"; \
        DROP ROLE IF EXISTS \"{{name}}\";" \
      default_ttl="1h" \
      max_ttl="24h"
    
    echo "Creating read-write role..."
    vault write database/roles/mnbara-readwrite \
      db_name=mnbara-postgresql \
      creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; \
        GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO \"{{name}}\"; \
        GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO \"{{name}}\"; \
        GRANT USAGE ON SCHEMA public TO \"{{name}}\";" \
      revocation_statements="REVOKE ALL PRIVILEGES ON ALL TABLES IN SCHEMA public FROM \"{{name}}\"; \
        REVOKE ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public FROM \"{{name}}\"; \
        DROP ROLE IF EXISTS \"{{name}}\";" \
      default_ttl="1h" \
      max_ttl="24h"
    
    echo "Creating admin role..."
    vault write database/roles/mnbara-admin \
      db_name=mnbara-postgresql \
      creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}' SUPERUSER; \
        GRANT ALL PRIVILEGES ON DATABASE mnbara_db TO \"{{name}}\";" \
      revocation_statements="REVOKE ALL PRIVILEGES ON DATABASE mnbara_db FROM \"{{name}}\"; \
        DROP ROLE IF EXISTS \"{{name}}\";" \
      default_ttl="30m" \
      max_ttl="2h"
    
    echo "Database secrets engine configured successfully!"

  # Script to configure Redis dynamic credentials (if using Redis Enterprise)
  configure-redis-engine.sh: |
    #!/bin/sh
    set -e
    
    # Note: Redis dynamic credentials require Redis Enterprise
    # For standard Redis, use static credentials from KV store
    
    echo "Redis dynamic credentials configuration skipped (requires Redis Enterprise)"

---
# Job to configure database secrets engine
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-database-config
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: database-secrets
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      serviceAccountName: vault-database-config
      restartPolicy: OnFailure
      containers:
        - name: configure-database
          image: hashicorp/vault:1.15
          command:
            - /bin/sh
            - -c
            - |
              # Wait for Vault to be ready and unsealed
              until vault status 2>/dev/null | grep -q "Sealed.*false"; do
                echo "Waiting for Vault to be unsealed..."
                sleep 5
              done
              
              # Login with Kubernetes auth
              vault login -method=kubernetes role=database-config
              
              # Run configuration script
              /scripts/configure-database-engine.sh
          env:
            - name: VAULT_ADDR
              value: "https://vault.vault:8200"
            - name: VAULT_CACERT
              value: "/vault/tls/ca.crt"
            - name: POSTGRES_ADMIN_USER
              valueFrom:
                secretKeyRef:
                  name: vault-database-admin
                  key: username
            - name: POSTGRES_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: vault-database-admin
                  key: password
          volumeMounts:
            - name: scripts
              mountPath: /scripts
            - name: tls
              mountPath: /vault/tls
              readOnly: true
      volumes:
        - name: scripts
          configMap:
            name: vault-database-config
            defaultMode: 0755
        - name: tls
          secret:
            secretName: vault-tls

---
# ServiceAccount for database config job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-database-config
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: database-secrets

---
# Secret for database admin credentials (used to create dynamic roles)
apiVersion: v1
kind: Secret
metadata:
  name: vault-database-admin
  namespace: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/component: database-secrets
type: Opaque
stringData:
  username: "postgres"
  password: ""  # Set via external secrets or manually
