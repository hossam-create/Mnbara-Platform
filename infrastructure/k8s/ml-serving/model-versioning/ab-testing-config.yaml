# Model Versioning and A/B Testing Configuration
# Requirements: 17.4 - Personalized recommendations based on browsing history
apiVersion: v1
kind: ConfigMap
metadata:
  name: model-versioning-config
  namespace: ml-serving
data:
  model-registry.yaml: |
    # Model Registry Configuration
    registry:
      backend: mlflow
      tracking_uri: http://mlflow-server:5000
      artifact_store: s3://mnbara-mlflow-artifacts
    
    # Model Lifecycle Stages
    stages:
      - name: development
        auto_promote: false
        validation_required: false
      - name: staging
        auto_promote: false
        validation_required: true
        validation_metrics:
          - metric: accuracy
            threshold: 0.85
          - metric: latency_p99_ms
            threshold: 100
      - name: production
        auto_promote: false
        validation_required: true
        approval_required: true
    
    # Model Types
    models:
      recommendation:
        name: recommendation-model
        description: Product recommendation model using collaborative filtering
        input_schema:
          type: object
          properties:
            user_id: { type: integer }
            context: { type: object }
        output_schema:
          type: array
          items:
            type: object
            properties:
              product_id: { type: integer }
              score: { type: number }
      
      contextual_bandit:
        name: contextual-bandit-model
        description: Multi-armed bandit for exploration/exploitation
        input_schema:
          type: object
          properties:
            user_id: { type: integer }
            context_features: { type: array }
            available_arms: { type: array }
        output_schema:
          type: object
          properties:
            selected_arm: { type: integer }
            expected_reward: { type: number }

  ab-testing.yaml: |
    # A/B Testing Configuration
    experiments:
      - name: recommendation-model-v2
        description: Testing new collaborative filtering model
        status: active
        start_date: "2024-01-01"
        end_date: "2024-03-01"
        traffic_allocation:
          control:
            model_version: v1.0.0
            percentage: 50
          treatment:
            model_version: v2.0.0
            percentage: 50
        metrics:
          primary:
            - name: click_through_rate
              type: ratio
              numerator: clicks
              denominator: impressions
          secondary:
            - name: conversion_rate
              type: ratio
            - name: revenue_per_user
              type: mean
        targeting:
          user_segments: ["all"]
          exclude_segments: ["internal_testers"]
      
      - name: bandit-vs-static
        description: Comparing contextual bandit vs static recommendations
        status: active
        traffic_allocation:
          control:
            model_type: static
            percentage: 30
          treatment:
            model_type: contextual_bandit
            percentage: 70
        metrics:
          primary:
            - name: cumulative_reward
              type: sum
    
    # Traffic Routing Rules
    routing:
      default_model: recommendation-model
      default_version: production
      
      rules:
        - name: new-user-routing
          condition: "user.is_new == true"
          model: contextual_bandit
          version: staging
        
        - name: high-value-user-routing
          condition: "user.lifetime_value > 1000"
          model: recommendation-model
          version: production
          
    # Rollout Configuration
    rollout:
      canary:
        enabled: true
        initial_percentage: 5
        increment_percentage: 10
        increment_interval_minutes: 30
        max_percentage: 100
        rollback_threshold:
          error_rate: 0.05
          latency_p99_ms: 200
---
# A/B Testing Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ab-testing-router
  namespace: ml-serving
  labels:
    app: ab-testing-router
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ab-testing-router
  template:
    metadata:
      labels:
        app: ab-testing-router
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      containers:
        - name: router
          image: mnbara/ab-testing-router:latest
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: CONFIG_PATH
              value: "/config"
            - name: MLFLOW_TRACKING_URI
              value: "http://mlflow-server:5000"
            - name: TORCHSERVE_URL
              value: "http://torchserve:8080"
            - name: REDIS_URL
              value: "redis://redis:6379"
          volumeMounts:
            - name: config
              mountPath: /config
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: model-versioning-config
---
apiVersion: v1
kind: Service
metadata:
  name: ab-testing-router
  namespace: ml-serving
spec:
  selector:
    app: ab-testing-router
  ports:
    - port: 8080
      targetPort: 8080
      name: http
  type: ClusterIP
---
# Model Version CRD for GitOps-style model deployment
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: modelversions.ml.mnbara.io
spec:
  group: ml.mnbara.io
  versions:
    - name: v1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                modelName:
                  type: string
                version:
                  type: string
                stage:
                  type: string
                  enum: ["development", "staging", "production", "archived"]
                mlflowRunId:
                  type: string
                artifactUri:
                  type: string
                metrics:
                  type: object
                  additionalProperties:
                    type: number
                trafficPercentage:
                  type: integer
                  minimum: 0
                  maximum: 100
            status:
              type: object
              properties:
                phase:
                  type: string
                lastUpdated:
                  type: string
                replicas:
                  type: integer
      additionalPrinterColumns:
        - name: Model
          type: string
          jsonPath: .spec.modelName
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Stage
          type: string
          jsonPath: .spec.stage
        - name: Traffic
          type: integer
          jsonPath: .spec.trafficPercentage
  scope: Namespaced
  names:
    plural: modelversions
    singular: modelversion
    kind: ModelVersion
    shortNames:
      - mv
