# TLS 1.3 Configuration for All Services
# Requirements: 19.1 - Data encryption in transit
---
# ClusterIssuer for internal certificates using Vault PKI
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-ca-issuer
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: issuer
spec:
  vault:
    path: pki_int/sign/mnbara-service
    server: https://vault.vault:8200
    caBundle: ""  # Will be populated from vault-ca secret
    auth:
      kubernetes:
        role: cert-manager
        mountPath: /v1/auth/kubernetes
        serviceAccountRef:
          name: cert-manager

---
# ClusterIssuer for public certificates using Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: issuer
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: security@mnbara.com
    privateKeySecretRef:
      name: letsencrypt-prod-account-key
    solvers:
      - http01:
          ingress:
            class: nginx
      - dns01:
          route53:
            region: us-east-1
            hostedZoneID: HOSTED_ZONE_ID

---
# TLS Policy ConfigMap for service mesh
apiVersion: v1
kind: ConfigMap
metadata:
  name: tls-policy
  namespace: mnbara
  labels:
    app.kubernetes.io/name: mnbara
    app.kubernetes.io/component: security
data:
  # TLS 1.3 only policy
  tls-policy.yaml: |
    apiVersion: security.istio.io/v1beta1
    kind: PeerAuthentication
    metadata:
      name: default
      namespace: mnbara
    spec:
      mtls:
        mode: STRICT
      
  # Destination rule for TLS settings
  destination-rule.yaml: |
    apiVersion: networking.istio.io/v1beta1
    kind: DestinationRule
    metadata:
      name: mnbara-tls
      namespace: mnbara
    spec:
      host: "*.mnbara.svc.cluster.local"
      trafficPolicy:
        tls:
          mode: ISTIO_MUTUAL
          minProtocolVersion: TLSV1_3
          cipherSuites:
            - TLS_AES_256_GCM_SHA384
            - TLS_CHACHA20_POLY1305_SHA256
            - TLS_AES_128_GCM_SHA256

---
# Istio PeerAuthentication for mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: mnbara
  labels:
    app.kubernetes.io/name: mnbara
    app.kubernetes.io/component: security
spec:
  mtls:
    mode: STRICT

---
# DestinationRule for TLS 1.3
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: mnbara-tls-policy
  namespace: mnbara
  labels:
    app.kubernetes.io/name: mnbara
    app.kubernetes.io/component: security
spec:
  host: "*.mnbara.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
      minProtocolVersion: TLSV1_3
      cipherSuites:
        - TLS_AES_256_GCM_SHA384
        - TLS_CHACHA20_POLY1305_SHA256
        - TLS_AES_128_GCM_SHA256

---
# API Gateway TLS Certificate
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-gateway-tls
  namespace: mnbara
  labels:
    app.kubernetes.io/name: api-gateway
    app.kubernetes.io/component: tls
spec:
  secretName: api-gateway-tls
  duration: 2160h  # 90 days
  renewBefore: 360h  # 15 days
  subject:
    organizations:
      - MNBARA
  commonName: api.mnbara.com
  isCA: false
  privateKey:
    algorithm: RSA
    encoding: PKCS1
    size: 2048
  usages:
    - server auth
    - digital signature
    - key encipherment
  dnsNames:
    - api.mnbara.com
    - "*.api.mnbara.com"
    - api-gateway
    - api-gateway.mnbara
    - api-gateway.mnbara.svc
    - api-gateway.mnbara.svc.cluster.local
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
    group: cert-manager.io

---
# Internal service certificates template
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: auth-service-tls
  namespace: mnbara
  labels:
    app.kubernetes.io/name: auth-service
    app.kubernetes.io/component: tls
spec:
  secretName: auth-service-tls
  duration: 8760h  # 1 year
  renewBefore: 720h  # 30 days
  subject:
    organizations:
      - MNBARA
  commonName: auth-service
  isCA: false
  privateKey:
    algorithm: ECDSA
    size: 256
  usages:
    - server auth
    - client auth
    - digital signature
    - key encipherment
  dnsNames:
    - auth-service
    - auth-service.mnbara
    - auth-service.mnbara.svc
    - auth-service.mnbara.svc.cluster.local
    - localhost
  ipAddresses:
    - 127.0.0.1
  issuerRef:
    name: vault-ca-issuer
    kind: ClusterIssuer
    group: cert-manager.io

---
# Ingress with TLS termination
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: mnbara-api
  namespace: mnbara
  labels:
    app.kubernetes.io/name: mnbara
    app.kubernetes.io/component: ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-ssl-protocols: "TLSv1.3"
    nginx.ingress.kubernetes.io/ssl-ciphers: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
    nginx.ingress.kubernetes.io/ssl-prefer-server-ciphers: "true"
    # HSTS
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-Frame-Options "DENY" always;
      add_header X-XSS-Protection "1; mode=block" always;
    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"
spec:
  tls:
    - hosts:
        - api.mnbara.com
      secretName: api-gateway-tls
  rules:
    - host: api.mnbara.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 8080

---
# NGINX ConfigMap for TLS settings
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-tls-config
  namespace: ingress-nginx
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/component: config
data:
  # TLS 1.3 only
  ssl-protocols: "TLSv1.3"
  ssl-ciphers: "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
  ssl-prefer-server-ciphers: "true"
  ssl-session-cache: "shared:SSL:10m"
  ssl-session-timeout: "1d"
  ssl-session-tickets: "false"
  # OCSP Stapling
  ssl-stapling: "true"
  ssl-stapling-verify: "true"
  # Security headers
  hsts: "true"
  hsts-max-age: "31536000"
  hsts-include-subdomains: "true"
  hsts-preload: "true"
  # Additional security
  server-tokens: "false"
  hide-headers: "X-Powered-By,Server"
