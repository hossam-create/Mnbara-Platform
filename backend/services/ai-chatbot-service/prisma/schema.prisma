// AI Chatbot Service - ÿÆÿØŸÖÿ© ÿßŸÑÿØÿ±ÿØÿ¥ÿ© ÿßŸÑÿ∞ŸÉŸäÿ©
// 24/7 AI-powered customer support

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// üí¨ CHAT CONVERSATIONS
// ==========================================

model Conversation {
  id              String   @id @default(uuid())
  userId          String?
  sessionId       String   // For anonymous users
  
  // Channel
  channel         Channel  @default(WEB)
  
  // Language
  language        String   @default("ar")
  
  // Status
  status          ConversationStatus @default(ACTIVE)
  
  // Escalation
  isEscalated     Boolean  @default(false)
  escalatedTo     String?  // Agent ID
  escalatedAt     DateTime?
  escalationReason String?
  
  // Satisfaction
  rating          Int?     // 1-5
  feedback        String?
  
  // Stats
  messageCount    Int      @default(0)
  
  messages        Message[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?
  
  @@index([userId, createdAt])
  @@index([status])
}

enum Channel {
  WEB
  MOBILE
  WHATSAPP
  FACEBOOK
  INSTAGRAM
  EMAIL
}

enum ConversationStatus {
  ACTIVE
  WAITING_USER
  WAITING_AGENT
  ESCALATED
  RESOLVED
  CLOSED
}

// ==========================================
// üìù MESSAGES
// ==========================================

model Message {
  id              String   @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id])
  
  // Sender
  senderType      SenderType
  senderId        String?  // userId or agentId
  
  // Content
  content         String
  contentType     ContentType @default(TEXT)
  
  // Attachments
  attachments     Json?    // Array of attachment URLs
  
  // AI Processing
  intent          String?
  confidence      Float?
  entities        Json?
  sentiment       Sentiment?
  
  // Response
  isAutoResponse  Boolean  @default(false)
  responseTime    Int?     // ms
  
  createdAt       DateTime @default(now())
  
  @@index([conversationId, createdAt])
}

enum SenderType {
  USER
  BOT
  AGENT
}

enum ContentType {
  TEXT
  IMAGE
  FILE
  AUDIO
  VIDEO
  LOCATION
  PRODUCT
  ORDER
  QUICK_REPLY
}

enum Sentiment {
  VERY_POSITIVE
  POSITIVE
  NEUTRAL
  NEGATIVE
  VERY_NEGATIVE
}

// ==========================================
// üéØ INTENTS
// ==========================================

model Intent {
  id              String   @id @default(uuid())
  name            String   @unique
  nameAr          String
  
  // Description
  description     String?
  descriptionAr   String?
  
  // Category
  category        IntentCategory
  
  // Training
  trainingPhrases String[]
  trainingPhrasesAr String[]
  
  // Response Templates
  responses       IntentResponse[]
  
  // Actions
  action          String?  // API action to trigger
  actionParams    Json?
  
  // Confidence threshold
  minConfidence   Float    @default(0.7)
  
  // Status
  isEnabled       Boolean  @default(true)
  
  // Stats
  matchCount      Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([category, isEnabled])
}

enum IntentCategory {
  GREETING
  FAREWELL
  ORDER_STATUS
  PRODUCT_INFO
  SHIPPING
  RETURNS
  PAYMENT
  ACCOUNT
  COMPLAINT
  FEEDBACK
  FAQ
  ESCALATION
  OTHER
}

model IntentResponse {
  id              String   @id @default(uuid())
  intentId        String
  intent          Intent   @relation(fields: [intentId], references: [id])
  
  // Response
  response        String
  responseAr      String
  
  // Conditions
  conditions      Json?    // When to use this response
  
  // Priority
  priority        Int      @default(0)
  
  createdAt       DateTime @default(now())
  
  @@index([intentId])
}

// ==========================================
// üìö KNOWLEDGE BASE
// ==========================================

model KnowledgeArticle {
  id              String   @id @default(uuid())
  
  // Content
  title           String
  titleAr         String
  content         String   @db.Text
  contentAr       String   @db.Text
  
  // Category
  category        String
  tags            String[]
  
  // Search
  keywords        String[]
  keywordsAr      String[]
  
  // Status
  isPublished     Boolean  @default(true)
  
  // Stats
  viewCount       Int      @default(0)
  helpfulCount    Int      @default(0)
  notHelpfulCount Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([category, isPublished])
}

// ==========================================
// ü§ñ BOT CONFIGURATION
// ==========================================

model BotConfig {
  id              String   @id @default(uuid())
  
  // Identity
  name            String   @default("Mnbara Assistant")
  nameAr          String   @default("ŸÖÿ≥ÿßÿπÿØ ŸÖŸÜÿ®ÿ±ÿ©")
  avatar          String?
  
  // Personality
  personality     String   @default("friendly")
  tone            String   @default("professional")
  
  // Languages
  supportedLanguages String[] @default(["ar", "en"])
  defaultLanguage String   @default("ar")
  
  // Behavior
  greetingMessage String
  greetingMessageAr String
  fallbackMessage String
  fallbackMessageAr String
  
  // Escalation
  autoEscalateAfter Int    @default(3) // Failed attempts
  escalationMessage String
  escalationMessageAr String
  
  // Working Hours
  workingHours    Json?    // { start: "09:00", end: "21:00" }
  offlineMessage  String?
  offlineMessageAr String?
  
  // Status
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==========================================
// üë®‚Äçüíº AGENTS
// ==========================================

model Agent {
  id              String   @id @default(uuid())
  userId          String   @unique
  
  // Info
  name            String
  email           String
  avatar          String?
  
  // Skills
  languages       String[]
  specializations String[]
  
  // Status
  status          AgentStatus @default(OFFLINE)
  maxConcurrent   Int      @default(5)
  currentChats    Int      @default(0)
  
  // Stats
  totalChats      Int      @default(0)
  avgRating       Float?
  avgResponseTime Float?   // seconds
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
}

enum AgentStatus {
  ONLINE
  BUSY
  AWAY
  OFFLINE
}

// ==========================================
// üìä ANALYTICS
// ==========================================

model ChatAnalytics {
  id              String   @id @default(uuid())
  date            DateTime @db.Date
  
  // Volume
  totalConversations Int   @default(0)
  totalMessages   Int      @default(0)
  uniqueUsers     Int      @default(0)
  
  // Resolution
  resolvedByBot   Int      @default(0)
  escalatedToAgent Int     @default(0)
  
  // Performance
  avgResponseTime Float?   // ms
  avgConversationTime Float? // seconds
  
  // Satisfaction
  avgRating       Float?
  positiveRatings Int      @default(0)
  negativeRatings Int      @default(0)
  
  // Intents
  topIntents      Json?    // { intent: count }
  
  // Sentiment
  positiveSentiment Int    @default(0)
  neutralSentiment Int     @default(0)
  negativeSentiment Int    @default(0)
  
  createdAt       DateTime @default(now())
  
  @@unique([date])
  @@index([date])
}
